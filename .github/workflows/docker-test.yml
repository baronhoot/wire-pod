name: Docker Test Build

# This workflow tests Docker builds for wire-pod with OpenAI Whisper support
# It runs on pull requests and development branches to ensure builds succeed

on:
  pull_request:
    branches: [ "main" ]
  push:
    branches: [ "dev", "develop", "feature/*", "hotfix/*" ]
  workflow_dispatch:  # Allow manual triggering

env:
  WHISPER_MODEL: tiny

jobs:
  test-build:
    name: Test Docker Build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Set up Docker Buildx for testing
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Test build without pushing (dry run)
      - name: Test Docker build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: test:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
          build-args: |
            WHISPER_MODEL=${{ env.WHISPER_MODEL }}

      # Test multi-platform build (without pushing)
      - name: Test multi-platform build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: test:multi
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
          build-args: |
            WHISPER_MODEL=${{ env.WHISPER_MODEL }}

      # Add test summary
      - name: Test Summary
        if: always()
        run: |
          echo "## ðŸ§ª Docker Test Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Whisper Model:** ${{ env.WHISPER_MODEL }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **AMD64 build:** Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tested platforms:** linux/amd64" >> $GITHUB_STEP_SUMMARY
          echo "**Features tested:** OpenAI Whisper STT, CUDA support" >> $GITHUB_STEP_SUMMARY
